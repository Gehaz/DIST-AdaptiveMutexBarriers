\section{Full Lower Bound Proofs}
\label{sec:FullProof}

We start by stating a few lemmas and claims that are required for arguing about the properties of our construction, which we specify in a formal manner later. The proofs are technical and appear in the appendix.

\begin{claim-num}  \label{claim: maintain-criticalness}
	Let $E$ be an execution fragment and $e \in E$ be an event issued by some process $p$.
	\begin{itemize}
		\item Assume $e$ is a non-special event in $E$. Then for any execution fragment $F \preceq E$ such that $F \mid p = E \mid p$, $e$ is a non-special event in $F$.
		\item Assume $e$ is a special event in $E$. Then for any execution fragment $F$ such that $E \preceq F$ and $F \mid p = E \mid p$, $e$ is a special event in $F$.
	\end{itemize}
\end{claim-num}

\begin{lemma} \label{lem: sub-execution}
	Let $E$ be an execution and let $p \in P$ be a process such that $p \notin AW(q,E)$ for any $q \neq p$. Then $E^{-p}$ is an execution.
\end{lemma}

\begin{lemma}  \label{lem: access-visible-variable}
	Let $E$ be an execution and let $\mathit{INV}$ be an IN-set of $E$. Let $e$ be a $read(v)$ or $write(v)$ event. Assume $writer(v,E) \notin \mathit{INV}$ and $owner(v) \notin Act(E)$. Then $\mathit{INV}$ satisfies IN1-IN4 of Definition \ref{def:inv} in $E e$.
\end{lemma}

\begin{claim} \label{claim: local-event-extension}
	Let $E$ be an execution and let $\mathit{INV}$ be an IN-set of $E$. Let $e$ be an extension of $E$ by some process $p$ such that $e$ is a local event in $E e$. Then $\mathit{INV}$ is an IN-set of $E e$.
\end{claim}

\begin{lemma} \label{lem: non-critical-extension}
	Let $E$ be an execution and let $\mathit{INV}$ be an IN-set of $E$. Let $F$ be an extension of $E$ such that $F$ contains no critical or transition event in $E F$. Then $\mathit{INV}$ is an IN-set of $E F$.
\end{lemma}

\begin{lemma} \label{lem: remove-invisibale-processes}
	Let $E$ be an execution, $\mathit{INV}$ be an IN-set of $E$ and $Y \subseteq \mathit{INV}$.
	\newline Define $E' = E^{-Y}$. Then the following hold:
	\begin{enumerate}
		\item $E'$ is an execution;
		\item $Act(E') = Act(E) \setminus Y$ and $Fin(E') = Fin(E)$;
		\item $\mathit{INV} \setminus Y$ is an IN-set of $E'$;
		\item Each $p \in Act(E')$ executes the same critical events in $E'$ and in $E$;
		\item If $p \in Act(E')$ is about to execute a special event $f_p$ after $E$, then $p$ is about to execute a special event $e_p \sim f_p$ after $E'$.
	\end{enumerate}
\end{lemma}

\begin{lemma} \label{lem: next-critical-extension}
	Let $E$ be a regular execution. Then there exists an extension $F$ such that the following hold:
	\begin{itemize}
		\item $F$ contains no special events in $E F$;
		\item $E F$ is a regular execution;
		\item Each $p \in Act(E)$ is about to execute a special event $f_p$ after $E F$. Moreover, at most one process $p \in Act(E)$ is about to execute $f_p=CS_p$ after $E F$.
	\end{itemize}
\end{lemma}

The proof of the following theorem appears in \cite{Bollobas2004}.

\begin{theorem} [Tur\'{a}n] ~\label{th: turan}
	Let $\mathcal{G} = (V,E)$ be an undirected graph, with vertex set $V$ and edge set $E$. If the average degree of $\mathcal{G}$ is $d$, then an independent set exists with at least $\lceil |V|/(d+1) \rceil$ vertices.
\end{theorem}
	
We now prove a tradeoff between the fence complexity and the adaptivity function $f$.
We start with the regular execution $H_0$ in which each process $p$ have executed the $Enter_p$ event only, hence $Act(H_0)=P$ and $Fin(H_0)=\emptyset$. We then build longer executions $H_1,H_2,...$ inductively. At each induction step, we construct $H_{i+1}$ from $H_i$ using three phases: read, write, and regularization. Each phase consists of a sequence of executions.

Every induction step starts with an execution $H_i$ that meets the following conditions:

\begin{enumerate}[(a)]
	\item $H_i$ is a regular execution;
	\item Each $p \in Act(H_i)$ executes $\ell_i$ critical events in $H_i$, for some $\ell_i \leq f(i)$;
	\item $|Fin(H_i)| = i$;
	\item Each $p \in Act(H_i)$ completes $i$ fences in $H_i$ and $mode(p,H_i) = read$.
\end{enumerate}

For simplicity, we slightly abuse notation and write $\ell$ instead of $\ell_i$ in the rest of this section.




\subsection{Read phase}
\label{subsec:read-phase}
In the course of the read phase, we construct a sequence of executions $H_i=G_0,G_1,G_2,\ldots,G_s, J_0$.

\begin{lemma} \label{read-phase-lemma}
	At each step during the read phase we have an execution $G_k$ satisfying the following conditions:
	\begin{enumerate}[(1)]
		\item $G_k$ is a regular execution;
		\item Each $p \in Act(G_k)$ executes $\ell+k$ critical events in $G_k$;
		\item Each $p \in Act(G_k)$ completes $i$ fences in $G_k$ and $mode(p,G_k) = read$;
		\item $Fin(G_k) = Fin(H_i)$;
		\item $|Act(G_k)| \geq (|Act(G_{k-1})|-1)/10$.
	\end{enumerate}
\end{lemma}

\vspace{3mm} First notice that $G_0 = H_i$ satisfies all the conditions in Lemma \ref{read-phase-lemma}. Assume we already constructed $G_{k-1}$ satisfying the conditions in Lemma \ref{read-phase-lemma}. We let $G=G_{k-1}$ and $n=|Act(G_{k-1})|$ in the rest of this section (\ref{subsec:read-phase}), in which we specify the construction of the read phase and prove Lemma \ref{read-phase-lemma}.

\subsubsection{Construction: stage 1}
By Lemma \ref{lem: next-critical-extension}, there exists an extension $F$ of $G$ such that the following hold:
\begin{enumerate}
	\item $F$ contains no special events in $G F$;
	\item $G F$ is a regular execution;
	\item $F$ contains no transition events, therefore $Act(G F) = Act(G)$ and $Fin(G F) = Fin(G) = Fin(H_i)$;
	\item Each $p \in Act(G)$ executes $\ell+k-1$ critical events in $G F$;
	\item $F$ contains no fence events, hence each $p \in Act(G)$ completes $i$ fences in $G F$ and $mode(p,G F) = mode(p,G) = read$;
	\item Each $p \in Act(G)$ is about to execute a special event $f_p$ after $G F$. Moreover, at most a single process $q \in Act(G)$ is about to execute $f_q=CS_q$.
\end{enumerate}
Denote by $Y$ the set of processes in $Act(G)$ such that $f_p \neq CS_p$. We have $n-1 \leq |Y| \leq n$. For each $p \in Y$, since $status(p,G F) = entry$ and $f_p \neq CS_p$ we get that $f_p$ is not a transition event, and since $mode(p,G F) = read$ we get that $f_p$ is either a read event or a $BeginFence$ event.
\\ We define: $Z_1 = \{p \in Y \mid f_p = BeginFence\}$, $Z_2 = \{p \in Y \mid f_p \text{ is a read event}\}$.
\\ It follows that $Y = Z_1 \cup Z_2$ and $Z_1 \cap Z_2 = \emptyset$, thus $|Y|=|Z_1|+|Z_2|$.

\subsubsection*{\hspace{5mm} Case I: $\bf |Z_1| > |Y|/2$}
We define $W = Z_1$. We have $|W| > |Y|/2 \geq (n-1)/2$, thus $|W| \geq n/2$.

\subsubsection*{\hspace{5mm} Case\ II: $\bf |Z_2| \geq |Y|/2$}
We construct an undirected graph $\mathcal{G}$ as follows: the vertices of $\mathcal{G}$ are the processes in $Z_2$. Consider $p \in Z_2$ and denote $f_p = read(v)$. We add an edge $\{p,q\}$ if there exists $q \in Z_2$ such that $v$ is local to $q$ or $writer(v, G F) = q$.
\\ Since $v$ is local to at most one process and has at most one last writer, $p$ accounts for at most 2 edges in $\mathcal{G}$, thus the average degree in $\mathcal{G}$ is at most 4. By Theorem \ref{th: turan}, there exists an independent set $W \subseteq Z_2$ in $\mathcal{G}$ such that:
$$|W| \geq |Z_2|/5 \geq |Y|/10 \geq (n-1)/10$$

\subsubsection{Construction: stage 2}
We have a set of processes $W \subseteq Act(G F)$. Define $\overline{W} = Act(G F) \setminus W$. By Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow G F$ and $'Y' \leftarrow \overline{W}$, we have an execution $N = (G F)^{-\overline{W}}$ such that the following hold:
\begin{enumerate}
	\item $W = Act(G F) \setminus \overline{W}$ is an IN-set of $N$;
	\item $Act(N) = Act(G F) \setminus \overline{W} = W$, and $Fin(N) = Fin(G F) = Fin(H_i)$;
	\item From 1 and 2: $N$ is a regular execution;
	\item Each $p \in W$ executed the same critical events in $N$ and in $G F$, thus $p$ executed $\ell+k-1$ critical events in $N$;
	\item For each $p \in W$, since $N \mid p = (G F) \mid p$ we get that $p$ completed $i$ fences in $N$ and $mode(p,N) = mode(p, G F) = read$;
	\item Each $p \in W$ is about to execute a special event $e_p \sim f_p$ after $N$.
\end{enumerate}

We extend $N$ by letting each $p \in W$ execute its next event in an arbitrary order. Denote this extension by $D$, and define $G_k = N D$. Notice that $Act(G_k) = Act(N) = W$ and $Fin(G_k) = Fin(N) = Fin(H_i)$ since $D$ contains no transition events.

We now analyze the resulting execution, $G_k$, according to the cases defined in stage 1.
\subsubsection*{\hspace{5mm} Case I}
Define $s=k-1$ and $J_0 = G_k$. For each $p \in W$ we have $e_p \sim f_p = BeginFence$. The following conditions hold.
\begin{enumerate}
	\item $D$ contains fence events only, thus by Lemma \ref{lem: non-critical-extension}, $W$ is an IN-set of $J_0 = N D$, i.e. $J_0$ is a regular execution;
	\item Each $p \in Act(J_0)$ executed $\ell+s$ critical events in $N$ and thus in $J_0$;
	\item Each $p \in Act(J)$ completed $i$ fences in $J_0$, and the last event by $p$ in $J_0$ is BeginFence, i.e. $mode(p,J_0) = write$;
	\item $Fin(J_0) = Fin(H_i)$;
	\item $|Act(J_0)| = |W| \geq |Act(G_s)|/2$;
\end{enumerate}

We are done with the read phase, and we proceed to the write phase.

\subsubsection*{\hspace{5mm} Case II}
By the definition of $W$, each $p \in W$ executed a single read event $e_p$ in $D$.

\begin{claim-subsection} \label{claim: G_k-is-regular}
	$G_k$ is a regular execution.
\end{claim-subsection}

\begin{proof}	
	Consider $p \in W$, and denote $e_p = read(v)$.
	
	property 1: $writer(v,N) \notin W$.
	\\ Denote $q = writer(v, G F)$. If $q \notin Act (G F)$ then after removing the events by processes in $\overline{W} \subseteq Act(G F)$ we still have $writer(v,N) = writer(v,G F) = q$ and $q \notin W \subseteq Act(G F)$. Otherwise  $q \in Act(G F)$. $G F$ is a regular execution in which $q$ accessed $v$ and $writer(v, G F) \in Act(G F)$, thus by IN5 $q$ is the only process in $Act(G F)$ to access $v$. Notice that $q \notin W$ since there is an edge $\{p,q\}$ in $\mathcal{G}$, and $p \in W$, an independent set of $\mathcal{G}$. Therefore $q \in \overline{W}$, and after removing events by processes in $\overline{W}$ there is no process in $Act(G F)$ (and thus in $W$) to access $v$ in $N$, that is $writer(v,N) \notin W$.
	
	property 2: $owner(v) \notin W$:
	\\ Denote $q_v = owner(v)$. If $q_v \notin Z_2$ the claim clearly hold. Otherwise $q_v \in Z_2$ and $f_p \sim e_p = read(v)$, thus $\mathcal{G}$ contains an edge $\{p,q_v\}$ (notice that $p \neq q_v$ since $p$ remotely reads $v$). Since $p \in W$ and $W$ is an independent set we have $q_v \notin W$.
	
	Denote by $D_j$ the prefix of $D$ that contains exactly $j$ events. We prove by induction on $j$ ($0 \leq j \leq |D|$) that $W$ is an IN-set of $N D_j$:
	\\ induction base $j=0$: by our construction $W$ is an IN-set of $N$.
	\\ Assume we already proved the claim for $j < |D|$. Notice that $N D_{j+1} = N D_j e_p$ for some $p \in W$, and denote $e_p = read(v)$. Since $D_j$ contains no transition events, we have $Act(N D_j) = Act(N) = W$. $D_j$ contains only read events, thus no write to $v$ occurs in $D_j$, i.e. $writer(v, N D_j) = writer(v, N) \notin W$. Together with the fact that $owner(v) \notin W$, the conditions for Lemma \ref{lem: access-visible-variable} holds, and $W$ satisfies IN1-IN4 in $N D_j e_p = N D_{j+1}$. As IN5 holds for $W$ in $N D_j$ it clearly holds for any variable $u \neq v$ in $N D_{j+1}$. Since $e_p$ is a read event to $v$ we get $writer(v, N D_{j+1}) = writer(v, N D_j) \notin W$ and IN5 holds for $v$ in $N D_{j+1}$.
	
	Using the last claim with $j = |D|$ we have that $W$ is an IN-set of $N D = G_k$, and thus $G_k$ is a regular execution.
\end{proof}
	
We now prove that $G_k$ satisfies all the conditions in Lemma \ref{read-phase-lemma}:
\begin{enumerate}[(1)]
	\item $G_k$ is a regular execution;
	\item Consider $p \in W = Act(G_k)$. $p$ executed $\ell+k-1$ critical events in $N$ and a single event $e_p$ in $D$. By our construction $e_p$ is a critical event in $N e_p$, $N e_p \preceq G_k$, and $(N e_p) \mid p = G_k \mid p$. Therefore, by claim \ref{claim: maintain-criticalness}, $e_p$ is a critical event in $G_k$. Altogether $p$ executed $\ell+k$ critical events in $G_k$;
	\item Consider $p \in W$. $p$ completed $i$ fences in $N$ and $mode(p,N) = read$. Since $D$ contains a single read event by $p$ we get that $p$ completed $i$ fences in $G_k$ and $mode(p,G_k) = read$;
	\item $Fin(G_k) = Fin(N) = Fin(H_i)$;
	\item $|Act(G_k)| = |W| \geq (n-1)/10$.
\end{enumerate}

\begin{claim-section} \label{claim: read-upper-bound}
	The number of steps in the read phase is bounded by $f(i+1)-\ell$, that is, $\ell+s \leq f(i+1)$.
\end{claim-section}

\begin{proof}
	Assume towards a contradiction that during the read phase we build an execution $G_k$ such that $\ell+k > f(i+1)$. Then $G_k$ satisfies:
	\begin{itemize}
		\item $G_k$ is a regular execution;
		\item Each $p \in Act(G_k)$ executed $\ell+k$ critical events in $G_k$;
		\item $Fin(G_k) = Fin(H_i)$, thus $|Fin(G_k)| = i$.
	\end{itemize}
	We choose an arbitrary $p \in Act(G_k)$ and denote $Y = Act(G_k) \setminus \{p\}$. Using Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow G_k$ and $'Y' \leftarrow Y$, we have an execution $G'_k = G_k^{-Y}$ such that: $Act(G'_k) = \{p\}$ and $Fin(G'_k) = Fin(G_k) = Fin(H_i)$; $p$ executes the same critical events in $G_k$ and in $G'_k$, thus $p$ executes $\ell+k$ critical events in $G'_k$. Hence, at most $i+1$ processes issue events in $G'_k$, i.e. the total contention of $G'_k$ is at most $i+1$. However, $p$ executes $\ell+k > f(i+1)$ critical events during a single passage in $G'_k$, a contradiction to our assumption that the algorithm is $f$-adaptive.
\end{proof}




\newpage
\subsection{Write phase}
The read phase construct an execution $J$ such that the last event by each process in $Act(J)$ is BeginFence. The write phase will determine the order in which processes are executing their write commits along the fence. Each process $p \in Act(J)$ have a list $\alpha_p$ of writes in its write buffer, which it will commit starting from $J$.

We first focus on the list $\alpha_p$. Notice that $\alpha_p$ is also a solo run of $p$ starting from $J$ until the point where it finish executing its fence. Along the write phase, we first construct a set of processes out of $Act(J)$, such that the lists $\alpha_p$ of those processes satisfies certain properties. Then, we will use this set in order to extend $J$.
In the course of the write phase we construct a sequence of sets $Act(J) = P_0 \supseteq P_1 \supseteq \ldots \supseteq P_t$ satisfying the Lemma below.

\begin{lemma} \label{lemma-new}
	At each step of the write phase we have a set $P_k \subseteq Act(J)$ such that each process $p \in P_k$ has a prefix $\beta_p$ of $\alpha_p$ and the following hold:
	\begin{enumerate}[(1)]
		\item Each $p \in P_k$ is executing exactly $k$ critical writes along $\beta_p$ in the execution $J \beta_p$.
		\item Let $e \in \beta_p$ be a critical write in $J \beta_p$ by some process $p \in P_k$ to some variable $v$. Then, the following holds:
		\begin{enumerate}
			\item $owner(v) \notin P_k$;
			\item $writer(v,J) \notin P_k$;
			\item Either there is no $q \in P_k$ different then $p$ which access $v$ in $J \beta_q$, or that any process $q \in P_k$ have a write to $v$ in $\beta_q$.
		\end{enumerate}
		\item $|P_k| \geq \sqrt{|P_{k-1}|}/4(\ell+s+k)$.
	\end{enumerate}
\end{lemma}

First notice that $P_0=Act(J)$ satisfies all the above conditions with $\beta_p=\langle \rangle$ for any $p \in Act(J)$. Assume we already constructed $P_{k-1}$ satisfying the conditions of Lemma \ref{lemma-new}. For any $p \in P_{k-1}$ we denote by $\beta_p$ the prefix as promised by Lemma \ref{lemma-new} throughout the rest of this section, in which we define the construction of the write phase, and prove Lemma \ref{lemma-new}.

\subsubsection{Construction: stage 1}
For any $p \in P_{k-1}$ we let $p$ perform a solo run starting from $J \beta_p$ until its next event $e_p$ is a critical write, or that $p$ has finish executing $\alpha_p$ and its next event is $EndFence$. Denote this extension by $\gamma_p$. Notice that $\beta_p \gamma_p$ is indeed a prefix of $\alpha_p$ by its definition.
Let $Z$ be the set of all processes that have not finished executing $\alpha_p$, that is, $Z = \{p \in P_{k-1} \mid \beta_p \gamma_p \neq \alpha_p\}$.

If $|Z|<|P_{k-1}|/2$, i.e., at least half of the processes in $P_{k-1}$ have finished executing $\alpha_p$, then we define $t=k-1$ and $W = P_{k-1} \setminus Z$, and we move to stage 3 of the write phase.
By its definition, each process $p \in W$ executes $t$ critical writes along $\alpha_p$ in the execution $J \alpha_p$. Moreover, it is easy to verify that condition (2) of Lemma \ref{lemma-new} holds for $W$ with $\alpha_p$, since it holds for $W \subseteq P_{k-1}$ with $\beta_p$, and $\alpha_p = \beta_p \gamma_p$ where $\gamma_p$ contains no critical writes. Notice that no $p \in W$ can write to a remote variable in $\gamma_p$ it did not access in $J \beta_p$, as such write is critical, and therefore condition (2.c) follows immediately.

Otherwise $|Z| \geq |P_{k-1}|/2$. We define $V_{next}$ to be the set of variables that are about to be written in one of the next events $e_p$ by the processes in $Z$. Formally, $V_{next} = \{v \in V \mid \exists p \in Z \text{ such that } e_p \text{ remotely writes v}\}$. In order to construct $P_k$ the following stage will handle the cases of low and high contention separately.


\subsubsection{Construction: stage 2}


\subsubsection*{\hspace{5mm} Case I: $\bf |V_{next}| < \sqrt{|Z|}$}

By the pigeonhole principle, there exists a variable $u \in V_{next}$ and a set $P_k \subseteq Z$ of size $|P_k| \geq \sqrt{|Z|}$, such that $e_p$ is a critical commit write to $u$ for any $p \in P_k$.


\subsubsection*{\hspace{5mm} Case II: $\bf |V_{next}| \geq \sqrt{|Z|}$}

For each $v \in V_{next}$ we select an arbitrary $p \in Z$ such that $e_p = write(v)$. Denote this set by $Z'$. Then, $|Z'|=|V_{next}| \geq \sqrt{|Z|}$.
We construct an undirected graph $\mathcal{G}$ as follows: the vertices of $\mathcal{G}$ are the processes in $Z'$. Consider $p \in Z'$, and denote $e_p = write(v)$. For $q \in Z'$, we add an edge $\{p,q\}$ in $\mathcal{G}$ if either
\begin{inparaenum}[\itshape a\upshape)]
	\item $v$ is local to $q$; or
	\item $q$ access $v$ in $J \beta_q$.
\end{inparaenum}

Since each first access to a remote variable is critical, the number of different remote variables accessed by some process $p \in Z'$ is at most the number of critical events it executes. Therefore, the number of new edges introduce by rule b) for $p$ is at most the number of critical events $p$ executes in $J \beta_p$, which is $\ell+s+k-1$. Since each variable is local at most one process, at most one new edge is introduce by rule a).
Altogether, the average degree in $\mathcal{G}$ is at most $2(\ell+s+k)$. By Theorem \ref{th: turan}, there exists an independent set $P_k \subseteq Z'$ in $\mathcal{G}$ such that:

$$ |P_k| \geq \frac{|Z'|}{2(\ell+s+k)+1} \geq \frac{\sqrt{|Z|}}{2(\ell+s+k)+1}$$

We now prove that in both cases $P_k$ satisfies all the conditions of Lemma \ref{lemma-new}, where for each $p \in P_k$ we choose $\beta_p' = \beta_p \gamma_p e_p$ to be the prefix of $\alpha_p$.

\begin{claim-subsection}
	$P_k$ satisfies Lemma \ref{lemma-new}.
\end{claim-subsection}
 
 \begin{proof}
 	We first prove condition (2). Notice that $P_k$ satisfies it with the prefixes $\beta_p$, since $P_{k-1}$ did. Each $\beta_p$ was extended such that $p$ have one more critical write. In case I all processes have one more critical write to the same variable $u$. In case II all new critical writes are to different variables, where the independent set assures no such variable is accessed by some other process in $P_k$. This gives an intuition of why condition (2) holds with the new prefixes $\beta_p'$ as well. Formally, let $e \in \beta_p'$ be a critical write in $J \beta_p'$ by some $p \in P_k$ to some variable $v$. We consider two cases:
 	
 	Assume $e \in \beta_p$. Since (a) and (b) holds with $P_{k-1}$ and $P_k \subseteq P_{k-1}$, it follows immediately they both holds with $P_k$ as well. If any $q \in P_{k-1}$ have a write to $v$ in $\beta_q$, then so is the case with $\beta_q'$, and condition (c) holds. Otherwise, consider some $q \in P_k$ different then $p$. By condition (c) $q$ does not access $v$ in $J \beta_q$. Assume towards a contradiction it does access $v$ in $\gamma_q e_q$. Following condition (a) $q \neq owner(v)$, therefore this write is critical, i.e., it is $e_q$. In case I we get that $v=u$, and as so $p$ have two different critical write, $e$ and $e_p$, to the same variable $v$ along a solo run $\beta_p'$, in contradiction. In case II, we get that $p$ access the variable of $e_q$ in $J \beta_p$, thus there is an edge $\{p,q\}$ in $\mathcal{G}$, contradicting the fact that $p,q \in P_k$, an independent set.
 	
 	Otherwise $e=e_p$.
 	In case I, any $q \in P_k$ have a critical write $e_q$ to $u=v$, and therefore $q \neq owner(v)$. Moreover, $e_q$ must be the first write to $v$ in $\beta_q'$, as it is critical and $\beta_q'$ is a solo run. It follows that $q \neq writer(v,J)$, and conditions (2) follows.
 	In case II, consider some $q \in P_k$. If $q \neq owner(v)$ and it access $v$ in $J \beta_q'$, then the first such access is critical. This critical event is different then $e_q$, since $e_p$ and $e_q$ writes to different variables, therefore it must be in $J \beta_q$. In such case, or if $q = owner(v)$, there is an edge $\{p,q\}$ in $\mathcal{G}$. This contradict the fact that $P_k$ is an independent set. It follows that $q \neq owner(v)$, and it does not access $v$ in $J \beta_q'$, and in particular $q \neq writer(v,J)$, and condition (2) holds.
 	
 	Condition (1) follows from construction. By induction hypothesis, each $p \in P_k$ executes $k-1$ critical writes along $\beta_p$ in the run $J \beta_p$. We extended $\beta_p$ with a solo run such that $\gamma_p$ contains no critical events, end $e_p$ is a critical event. Therefore $p$ executes $k$ critical events along $\beta_p' = \beta_p \gamma_p e_p$ in the run $J \beta_p'$.
 	
 	For condition (3), in both cases we have a set $P_k$ satisfying:
 	$$|P_k| \geq \frac{\sqrt{|Z|}}{2(\ell+s+k)+1} \geq \frac{\sqrt{|P_{k-1}|/2}}{2(\ell+s+k)+1} \geq \frac{\sqrt{|P_{k-1}|}}{4(\ell+s+k)}$$
 \end{proof}

This finish the inductive step of the write phase. At the last step we have large enough set of processes that have finish executing $\alpha_p$. In this case, we move to stage 3, where we define how to use this set in order to construct the execution for the regularization phase.



\subsubsection{Construction: stage 3}

We have a set $W \subseteq Act(J)$ satisfying condition (2) of Lemma \ref{lemma-new} with $\alpha_p$, such that each $p \in W$ executes $t$ critical writes along $\alpha_p$ in the execution $J \alpha_p$.
We extend $J$ by letting each process $p \in W$ perform its run $\alpha_p$ in some arbitrary way. Denote this extension by $D$, and let $p_r \in W$ be the last process to perform its $\alpha_p$ in $D$. First notice the $D$ is indeed an extension of $J$ - since all processes performs only writes, we can order them in any way to get an extension, as writes of one process does not affect writes of other.

\begin{claim-subsection} \label{claim:IN3-write-phase}
	For any $Y \subseteq Act(J)$, $p \in W \setminus Y$, and $e \in \alpha_p$ the following holds:
	$e$ is a critical event in $J \alpha_p$ if and only if it is critical in $(J D)^{-Y}$.
\end{claim-subsection}

\begin{proof}
	Let $Y,p$ be as in the claim. Consider $e \in \alpha_p$, a write to variable $v$. 
	
	Assume $e$ is critical in $J \alpha_p$. By Lemma \ref{lemma-new} we have $owner(v) \notin W$ and $q = writer(v,J) \notin W$. If $q \notin Y$, then $q = writer(v,J^{-Y})$. Otherwise, $q \in Y$. Since $J$ is a regular execution, by IN5 $q$ is the only process in $Act(J)$ to access $v$ in $J$. After removing events by $q$ we get $writer(v,J^{-Y}) \notin Act(J)$. In particular, in both cases we have $writer(v,J^{-Y}) \neq p$.
	Notice that $e$ is the first write in $\alpha_p$ to $v$, since this event is critical in $J \alpha_p$. As a result, in $D^{-Y}$ $p$ executes $\alpha_p$, where the first write to $v$ in it is $e$, and all the events preceding $\alpha_p$ are by processes different then $p$. Therefore, either there is a write to $v$ before $e$ in $D^{-Y}$ by some process different then $p$, or that the last write is in $J^{-Y}$. In both cases we get that $e$ is a critical write in $J^{-Y} D^{-Y}$.
	
	Assume $e$ is not critical in $J \alpha_p$. If $e$ is not the first write to $v$ in $\alpha_p$, then so is the case in $D^{-Y}$ which contains $\alpha_p$, and on both cases $e$ is not a critical write. Otherwise, $e$ is the first write to $v$ in $\alpha_p$.
	If $p = owner(v)$, then by its definition a write by $p$ to $v$ is not critical in any execution, and we done. Assume $p \neq owner(v)$, then it must be that $p = writer(v,J)$. Since $J$ is regular, by IN4 $owner(v) \notin Act(J)$. Consider some $q \in W$ different then $p$, then $q \neq owner(v)$. If $q$ does write to $v$ in $\alpha_q$, the first such write is critical in $J \alpha_q$. By Lemma \ref{lemma-new} we get that $p=writer(v,J) \notin W$, in contradiction. As a result, no process in $W$ besides $p$ writes to $v$ in $D$, and therefore in $D^{-Y}$. Meaning, the last write to $v$ before $e$ in $J^{-Y} D^{-Y}$ is in $J^{-Y}$. As we did not remove events by process $p$ we have $p = writer(v,J^{-Y})$, and $e$ is not critical in $J^{-Y} D^{-Y}$.
\end{proof}

Denote $\overline{W} = Act(J) \setminus W$, and let $L_0 = (J D)^{-\overline{W}}$. Since no process in $\overline{W}$ take steps in $D$ we get $L_0 = J^{-\overline{W}} D$.
First notice that $L_0$ is indeed an execution. Since $J$ is a regular execution, by Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow J$ and $'Y' \leftarrow \overline{W}$, we have a regular execution $J^{-\overline{W}}$. Moreover, $D$ is an extension of $J^{-\overline{W}}$ - for any $p \in W$ we have $J \mid p = J^{-\overline{W}} \mid p$. Therefore, after both executions $p$ have the same writes, $\alpha_p$, in its write buffer. Furthermore, since all processes performs only writes in $D$, any order of these writes is an extension of $J^{-\overline{W}}$, as writes of one process does not affect writes of other.

\begin{claim-subsection}
	$W \setminus \{p_r\}$ is an IN-set of $L_0$.
\end{claim-subsection}

\begin{proof}
	Denote $W' = W \setminus \{p_r\}$. Notice that $J^{-\overline{W}}$ is a regular execution, and $W' \subseteq Act(J^{-\overline{W}}) = W$. Therefore $W'$ is an IN-set of $J^{-\overline{W}}$.
	
	IN1: for any $p \in P$ we have $AW(p,J^{-\overline{W}}) \cap W' \subseteq \{p\}$. In addition, $D$ contains only write events, therefore no process change its awareness-set along $D$, resulting $AW(p,J^{-\overline{W}} D) \cap W' \subseteq \{p\}$.
	
	IN2: for any $p \in W'$ we have $status(p,J^{-\overline{W}}) = entry$.  In addition, $D$ contains only write events, therefore no process change its status in $D$ and $status(p,J^{-\overline{W}} D) = entry$.
	
	IN3: consider $Y \subseteq W'$, and consider $e \in (J^{-\overline{W}} D)^{-Y}$. If $e \in (J^{-\overline{W}})^{-Y}$, then since $J^{-\overline{W}}$ is regular, by IN3 we get: $e$ is a critical event in $J^{-\overline{W}}$ if and only if it is critical in $(J^{-\overline{W}})^{-Y}$. Otherwise $e \in D^{-Y}$. Let $p$ be the process to execute $e$, then by claim \ref{claim:IN3-write-phase} we get: $e$ is critical in $(J D)^{-(\overline{W} \cup Y)} = (J^{-\overline{W}} D)^{-Y}$ if an and if it is critical in $J \alpha_p$ if and only if it is critical in $(J D)^{-\overline{W}} = L_0$.
	Altogether we get that $e$ is a critical event in $L_0$ if and only if it is critical in $L_0^{-Y}$.
	
	IN4: Let $e \in L_0$ be an event by $p$ accessing a remote variable $v$. w.l.o.g $e$ is the first access by $p$ to $v$ in $L_0$, and as so it is a critical event. If $e \in J^{-\overline{W}}$, then by IN4 we get $owner(v) \notin Act(J^{-\overline{W}}) = W =Act(L_0)$. Otherwise, $e \in D$, a critical write in $(J D)^{-\overline{W}}$. By claim \ref{claim:IN3-write-phase} $e$ is a critical write in $J \alpha_p$, and therefore by condition (2) of Lemma \ref{lemma-new} for $W$ we get $owner(v) \notin W = Act(L_0)$.
	
	IN5: Let $v$ be a variable such that $p = writer(v,L_0) \in W'$. If $v$ is local to $p$, then by IN4 there is no other process to write to $v$ in $L_0$, and we done. Assume otherwise, then by IN4 $owner(v) \notin W$. Let $e$ be the last critical write to $v$ in $L_0$. Notice that $e$ is an event by $p$, since it is the last process to write to $v$ in $L_0$.
	If $e \in D$, then by claim \ref{claim:IN3-write-phase} it is critical in $J \alpha_p$. By condition (2) of Lemma \ref{lemma-new}, either any $q \in W$ have a write to $v$ in its $\alpha_q$, and in particular, since $D$ ends with $\alpha_{p_r}$ we get $writer(v,L_0) = p_r \notin W'$ in contradiction. Therefore, there is no $q \neq p$ in $W$ to access $v$ in $J \alpha_q$, and thus in $L_0$, and IN5 holds ($Accessed(v,L_0) \cap Act(L_0) =\{p\}$).
	If $e \in J^{-\overline{W}}$, then no process but $p$ can write to $v$ in $D$ (since such write is critical, contradicting the fact that $e$ is the last such write). Furthermore, we have $writer(v,J^{-\overline{W}}) = p$, and since $J^{-\overline{W}}$ is a regular execution, by IN5 $p$ is the process in $Act(J^{-\overline{W}}) = W$ to access $v$ in $J^{-\overline{W}}$. Altogether, $p$ is the only process in $W$ to access $v$ in $L_0 = J^{-\overline{W}} D$, and IN5 holds.
\end{proof}

Each $p \in W$ commits all the writes in its write buffer along $D$, hence its next event is $EndFence$. We extend $L_0$ by letting each $p \in W$ execute $EndFence$ in some arbitrary order. By abuse of notation we denote the new execution by $L_0$ as well, since it retains all the properties of the previous $L_0$. Then $L_0$ satisfies the following conditions:
\begin{enumerate}
	\item $Act(L_0) \setminus \{p_r\}$ is an IN-set of $L_0$;
	\item Each $p \in Act(L_0) = W$ execute $\ell+s$ critical events in $J^{-\overline{W}}$, and by claim \ref{claim:IN3-write-phase} another $t$ critical events along $D$ in $J^{-\overline{W}} D$. Therefore, $p$ executes $\ell+s+t$ critical events in $L_0$;
	\item Each $p \in Act(L_0) = W$ completes $i$ fences in $J^{-\overline{W}}$, and have one more $EndFence$ as its last event in $L_0$. Thus, $p$ completes $i+1$ fences in $L_0$ and $mode(p,L_0) = read$;
	\item $Fin(L_0) = Fin(J) = Fin(H_i)$;
	\item $|Act(L_0)| \geq |P_k|/2$.
\end{enumerate}

This conclude the write phase, and we proceed to the regularization phase. We now give an upper bound on the number of steps in the read and write phases.

\begin{claim-section} \label{claim: write-upper-bound}
	The number of steps in the read and write phases is bounded by $f(i+1)-\ell$. In other words: $\ell+s+t \leq f(i+1)$.
\end{claim-section}

\begin{proof}
	Assume towards a contradiction that $\ell+s+t > f(i+1)$. Then we have an execution $L_0$ such that:
	\begin{itemize}
		\item $Act(L_0) \setminus \{p_r\}$ is an IN-set of $L_0$;
		\item $p_r$ executes $\ell+s+t$ critical events in $L_0$;
		\item $Fin(L_0) = Fin(H_i)$, thus $|Fin(L_0)| = i$;
	\end{itemize}

Using Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow L_0$ and $'Y' \leftarrow Act(L_0) \setminus \{p_r\}$, we have an execution $L' = L_0^{-Y}$ such that $Act(L') = \{p_r\}$ and $Fin(L') = Fin(L_0)$. By IN3 for $L_0$, $p_r$ executes the same critical events in $L_0$ and $L'$, that is, $p_r$ executes $\ell+s+t > f(i+1)$ critical events in $L'$. However, exactly $i+1$ processes issue events in $L'$, i.e. the total contention of $L'$ is $i+1$, while $p_r$ executes more then $f(i+1)$ critical events during a single passage in $L'$, a contradiction.
\end{proof}



\newpage
\subsection{Regularization phase}
The write phase construct an execution $L$ such that each process in $Act(L)$ completes $i+1$ fences. Moreover, $Act(L)$ can be written as $Q \cup \{p_r\}$ where $Q$ is an IN-set of $L$. The regularization phase will be used to let $p_r$ complete its passage, such that we get a regular execution.

By Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow L$ and $'Y' \leftarrow Q$ we get an execution $L^{-Q}$ such that the following holds:
\begin{enumerate}
	\item $Act(L^{-Q}) = Act(L) \setminus Q = \{p_r\}$;
	\item $Fin(L^{-Q}) = Fin(L) = Fin(H_i)$, and therefore $|Fin(L^{-Q})| = i$.
\end{enumerate}

Let $\alpha$ be a solo run of $p_r$ starting from $L^{-Q}$ until it finish its passage. Notice that such an extension exists by the progress property. We denote by $Q^-$ the set of processes $q \in Q$ such that there exist $e \in \alpha$, a critical event in $L^{-Q} \alpha$ accessing variable $v$, such that either $q = owner(v)$ or $q = writer(v,L)$.

We would like to extend $L$ with $\alpha$, but it might be that a solo run of $p_r$ after $L$ and $L^{-Q}$ is different. However, it is enough to erase the processes in $Q^-$ from $L$ to guarantee that $\alpha$ is also a solo run of $p_r$ after $L^{-Q^-}$.

Denote $Q = Q^- \cup Q^+$ a disjoint union, that is, $Q^+ = Q \setminus Q^-$. By Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow L$ and $'Y' \leftarrow Q^-$ we get that $L^{-Q^-}$ is an execution such that $Act(L^{-Q^-}) = Q^+ \cup \{p_r\}$ and $Q^+$ is an IN-set of $L^{-Q^-}$.

\begin{claim-subsection}
	For any variable $v$ accessed in $\alpha$: $writer(v,L^{-Q^-}) \notin Q$.
\end{claim-subsection}

\begin{proof}
	Assume towards a contradiction there is a variable $v$ such that $p_r$ access $v$ and $q = writer(v,L^{-Q^-}) \in Q$. Since no process in $Q^-$ takes steps in $L^{-Q^-}$ it follows that $q \notin Q^-$. By the definition of $Q^-$ we can conclude that $q \neq writer(v,L)$. Let $p$ be $writer(v,L)$, then $p \neq q$. It must be that $p \in Q^-$, otherwise $p$ executes the same events in $L$ and in $L^{-Q^-}$, and therefore it is the last process to write to $v$ in both, that is, $p = writer(v,L) = writer(v,L^{-Q^-}) = q$ in contradiction.
	Altogether, we have two different processes $p,q \in Q$ accessing $v$ in $L$. Since $Q$ is an IN-set of $L$, by IN5 $p = writer(v,L) \notin Q$, in contradiction.
\end{proof}

Using the claim above, for any variable $v$ accessed in $\alpha$ we have $q = writer(v,L^{-Q^-}) \notin Q$. That is, the last write to $v$ in $L^{-Q^-}$ is by a process not in $Q^+$, and therefore after erasing the processes in $Q^+$ from this execution, $q$ still executes the same events in the resulting execution, and thus the last write to $v$ in it is the same event by $q$. Meaning, in both $L^{-Q^-}$ and $(L^{-Q^-})^{-Q^+} = L^{-Q}$ the last event to write to $v$ is identical.

As a result, $p_r$ reads the same values from the same variables if running solo after both $L^{-Q^-}$ and $L^{-Q}$. Since $\alpha$ is a solo run of $p_r$ starting from $L^{-Q}$ it is also a solo run starting from $L^{-Q^-}$. Define $H_{i+1} = L^{-Q^-} \alpha$.

\begin{claim-subsection}
	$H_{i+1}$ is a regular execution.
\end{claim-subsection}

\begin{proof}
	
	As $Act(L^{-Q^-}) = Q^+ \cup \{p_r\}$, and in $\alpha$ we let $p_r$ finish its passage, we have $Act(H_{i+1}) = Q^+$. Notice that $Q^+$ is an IN-set of $L^{-Q^-}$. We prove it is also an IN-set of $H_{i+1}$.
	
	IN1: for any $p \in P$ we have $AW(p,L^{-Q^-}) \cap Q^+ \subseteq \{p\}$. If $p \neq p_r$ it does not take any steps in $\alpha$, and IN1 follows. In addition, in $L^{-Q} \alpha$ no process in $Q^+$ take steps, therefore $p_r$ does not become aware of any such process during this execution. As such, and since $p_r$ executes the exact same events in $L^{-Q} \alpha$ and in $H_{i+1}$, we have $AW(p_r, H_{i+1}) \cap Q^+ = \emptyset$ and we done.
	
	IN2: for any $p \in Q^+$ we have $status(p,L^{-Q^-}) = entry$. Since $p$ takes no steps in $\alpha$ we get $status(p,H_{i+1}) = entry$ as well.
	
	IN3: consider $Y \subseteq Q^+$. Then $H_{i+1}^{-Y} = (L^{-Q^-})^{-Y} \alpha$.
	Using IN3 with $L^{-Q^-}$, for any $e \in (L^{-Q^-})^{-Y}$: $e$ is a critical event in $(L^{-Q^-})^{-Y}$ if and only if it is a critical event in $L^{-Q^-}$. Since $(L^{-Q^-})$ is a prefix of $H_{i+1}$ it holds also with $H_{i+1}$.
	\\ For $e \in \alpha$ accessing a variable $v$, following the above proof for $H_{i+1}$ being an execution, the last event to write to $v$ in $L^{-Q}$ and in $L^{-Q^-}$ is the same. In particular, denote $q = writer(v,L^{-Q^-})$, then $q \notin Q$. Since we remove only events by processes in $q$ we get $q = writer(v,(L^{-Q^-})^{-Y})$.
	Now, notice that $e$ is a critical read in $H_{i+1}$ if and only if it is a critical read in $H_{i+1}^{-Y}$. This follow from the fact that a critical read is the first remote read of some variable by $p_r$, and it executes the exact same events on both executions.
	Otherwise, it is a critical write in $H_{i+1}$ if and only if it is the first write by $p_r$ to $v$ in $\alpha$ and $p_r \neq writer(v,L^{-Q^-}) = q$ (since $\alpha$ is a solo run by $p_r$, and any subsequent write to $v$ is not critical). This happens if and only if $e$ is the first write 
	\\ For $e \in \alpha$, first notice that $e$ is a critical read in $H_{i+1}$ if and only if it is a critical read in $H_{i+1}^{-Y}$. This follow from the fact that a critical read is the first remote read of some variable by $p_r$, and it executes the exact same events on both executions.
	Assume $e$ is a critical write in $H_{i+1}^{-Y}$. By claim \ref{claim: maintain-criticalness}, since $H_{i+1}^{-Y} \preceq H_{i+1}$ and $p$ executes the same events on both, it follows that $e$ is a critical write in $H_{i+1}$. It remains to prove the other direction.
	Assume $e$ is a critical write in $H_{i+1}$ to some $v$. Following the above proof for $H_{i+1}$ being an execution, since $p$ access $v$ in $\alpha$, then the last event to write to $v$ in $L^{-Q}$ and in $L^{-Q^-}$ is the same. In particular, denote $q = writer(v,L^{-Q^-})$, then $q \notin Q$. We remove only events by processes in $Q$, thus the last write to $v$ in $(L^{-Q^-})^-{Y}$ is still $q$.  Since $\alpha$ is a solo run by $p_r$, and $e \in \alpha$ is a solo run it follows that $e$ is the first write by $p_r$ to $v$ in $\alpha$.
	
	Moreover, $e$ is critical in $H_{i+1}$ because $q = writer(v,L^{-Q^-}) \neq p_r$. For proving 
	
	
\end{proof}









\newpage
In the regularization phase we construct a sequence of executions $L_0,L_1, \ldots, L_m, H_{i+1}$. Denote $\ell_{i+1} = \ell+s+t$.

\begin{lemma} \label{regularization-phase-lemma}
	In each step, we have an execution $L_k$ such that the following conditions hold:
	\begin{enumerate}[(1)]
		\item $Act(L_k) = W_k \cup \{p_r\}$ where $W_k$ is an IN-set of $L_k$;
		\item $p_r$ executes $\ell_{i+1}+k$ critical events in $L_k$;
		\item Each $p \in W_k$ executes $\ell_{i+1}$ critical events in $L_k$;
		\item Each $p \in W_k$ completes $i+1$ fences in $L_k$ and $mode(p,L_k) = read$;
		\item $Fin(L_k) = Fin(H_i)$;
		\item $|Act(L_k)| \geq |Act(L_{k-1})|-1$.
	\end{enumerate}
\end{lemma}

First notice that $L_0$ satisfies all the conditions of Lemma \ref{regularization-phase-lemma}. Assume we already constructed $L_{k-1}$ satisfying the conditions of Lemma \ref{regularization-phase-lemma}. We denote $L=L_{k-1},\ n=|Act(L_{k-1})|$ throughout the rest of this section, in which we define the construction of the regularization phase and prove Lemma \ref{regularization-phase-lemma}.

Lemma \ref{lem: non-critical-extension} implies that an extension containing no critical or transition events does not effect the IN-set, that is the IN-set remains the same after the extension. It is easy to verify that a transition event by a process not in the IN-set does not affect it as well (no variable is accessed, and the only process that changes its state is not in the IN-set). We therefore conclude that an extension by processes not in the IN-set which contains no critical events does not change the IN-set, and the next corollary follows.
\begin{corollary} \label{claim: q-extension}
	Let $F$ be an extension of $L$ by $p_{max}$ such that $F$ contains no critical events in $L F$. Then $W_{k-1}$ is an IN-set of $L F$.
\end{corollary}

Let $F$ be a solo extension of $L$ by $p_{max}$, where $p_{max}$ executes until it either terminates (that is, executes $Exit_{p_{max}}$), or until it is about to issue a critical event $f$. First, we prove that such an extension exists.

Assume towards a contradiction that the solo run $F$ by $p_{max}$ after $L$ is infinite, where $p_{max}$ does not finish a passage in $F$, and $F$ contains no critical events in $L F$. Consider a finite prefix $F'$ of $F$. $p_{max}$ does not finish a passage in $F$, thus $Act(L F') = Act(L)$. $F'$ contains no critical events in $L F'$, thus, by Corollary \ref{claim: q-extension}, $W_{k-1}$ is an IN-set of $L F'$. Using Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow L F'$, $'INV' \leftarrow W_{k-1}$ and $'Y' \leftarrow W_{k-1}$, we get an execution $L' = (L F')^{-W_{k-1}}$ such that $Act(L') = Act(L F') \setminus W_{k-1} = \{p_{max}\}$. Notice that $L'$ can be written as $L^{-W_{k-1}} F'$, since $F'$ is a solo run by $p_{max} \notin W_{k-1}$. We have an execution $L'$ in which there is a solo run $F'$ by $p_{max}$, where $p_{max}$ is the only active process along $F'$, and $p_{max}$ does not finish a passage. Since this holds for any prefix of $F$, $F'$ can be as long as we wish, thus contradicting the global progress property.

\subsubsection*{\hspace{5mm} Case I}
$p_{max}$ finishes a passage in $F$.
\\ Define $m = k-1$ and $H_{i+1} = L F$. The following conditions hold:
\begin{enumerate}
	\item Since $p_{max}$ finishes its passage in $F$, $Act(H_{i+1}) = Act(L) \setminus \{p_{max}\} = W_m$, thus $|Act(H_{i+1})| = |Act(L_m)|-1$;
	\item By Corollary \ref{claim: q-extension}, $W_m$ is an IN-set of $H_{i+1}$, thus $H_{i+1}$ is a regular execution;
	\item Each $p \in Act(H_{i+1})$ executes $\ell_{i+1}$ critical events in $L$, and thus in $H_{i+1}$;
	\item Since $p_{max}$ finishes its passage in $F$, we get $Fin(H_{i+1}) = Fin(L) \cup \{p_{max}\} = Fin(H_i) \cup \{p_{max}\}$. Therefore $|Fin(H_{i+1})| = i+1$;
	\item Each $p \in Act(H_{i+1})$ completes $i+1$ fences in $H_{i+1}$ and $mode(p,H_{i+1}) = read$.
\end{enumerate}
We are done with the regularization phase, and thus with the entire inductive step.

\subsubsection*{\hspace{5mm} Case II}
$p_{max}$ is about to execute a critical event $f$ after $L F$.
\\ Since $p_{max}$ does not finish its passage, $Act(L F) = Act(L)$ and $Fin(L F) = Fin(L) = Fin(H_i)$. $F$ contains no critical events in $L F$, thus by corollary \ref{claim: q-extension}, $W_{k-1}$ is an IN-set of $L F$. Let $u$ be the remote variable $p_{max}$ accesses in $f$. We define:

\begin{align*}
q & = \begin{cases}
	writer(u, L F) & ,writer(u, L F) \in W_{k-1}
	\\ \perp & ,otherwise
	\end{cases}
\\
q_u & = \begin{cases}
	owner(u) & ,owner(u) \in W_{k-1}
	\\ \perp & ,otherwise
	\end{cases}
\end{align*}

Denote $Q = \{q,q_u\}$ and $W_k = W_{k-1} \setminus Q$.
\begin{claim-subsection}
\label{claim:subsection}
	$|Q| \leq 1$ (where we do not count $\perp$).
\end{claim-subsection}
\begin{proof}
	Assume $|Q| = 2$, then $q,q_u \in W_{k-1}$ and $q \neq q_u$. Since $writer(u, L F) = q$ and $q \neq owner(u)$, $q$ remotely accessed $u$ in $L F$. $W_{k-1}$ is an IN-set of $L F$, thus by IN4 $q_u \notin Act(L F)$ - a contradiction.
\end{proof}

Since $Q \subseteq W_{k-1}$, by Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow L F$, $'INV' \leftarrow W_{k-1}$ and $'Y' \leftarrow Q$, we have: $N = (L F)^{-Q}$ is an execution, and the following hold:
\begin{enumerate}
	\item $W_k = W_{k-1} \setminus Q$ is an IN-set of $N$.
	\item $Act(N) = Act(L F) \setminus Q = W_k \cup \{p_{max}\}$, thus $|Act(N)| \geq |Act(L)| - 1$.
	\item $Fin(N) = Fin(L F) = Fin(H_i)$.
	\item Each $p \in W_k$ executes the same events in $N$ and in $L F$, thus $p$ completes $i+1$ fences in $N$ and $mode(p,N) = read$.
	\item Each $p \in Act(N)$ executes the same critical events in $N$ and in $L F$. Since $F$ contains no critical events in $L F$, each $p \in W_k$ executes $\ell_{i+1}$ critical events in $N$, and $p_{max}$ executes $\ell_{i+1}+k-1$ critical events in $N$.
	\item $p_{max}$ is about to execute a critical event $e \sim f$ after $N$.
\end{enumerate}

We extend $N$ by letting $p_{max}$ execute $e$, and denote the resulting execution $L_k = N e$.

\begin{claim-subsection} \label{claim: W_k-is-an-IN-set}
	$W_k$ is an IN-set of $L_k$.
\end{claim-subsection}

\begin{proof}

We start by proving two properties relating to variable $u$.

\begin{itemize}

\item property 1: $writer(u,N) \notin W_k$. If $writer(u, L F) \notin W_{k-1}$ then $q = \perp$, thus the events by $writer(u, L F)$ have not been removed from $N$ and we get $writer(u, N) = writer(u, L F) \notin W_k \subseteq W_{k-1}$. Otherwise, $writer(u, L F) = q \in W_{k-1}$. $W_{k-1}$ is an IN-set of $L F$, hence, by IN5, $q$ is the only process in $Act(L F)$ to access $u$ in $L F$ (otherwise $writer(u, L F) \notin W_{k-1}$, a contradiction). Therefore, after removing the events by $q \in Q$ there is no process in $W_{k-1}$ that accesses $u$ in $N$, i.e. $writer(u, N) \notin W_k \subseteq W_{k-1}$.
    
\item property 2: $owner(u,N) \notin Act(N)$. If $owner(u) \notin Act(L F)$, then $owner(u) \notin Act(N) \subseteq Act(L F)$. Otherwise, $owner(u) \in Act(L F)$. Since $p_{max}$ remotely accesses $u$ in $f$, we have $owner(u) \neq p_{max}$, thus  $owner(u) \in W_{k-1}$. From our construction, $owner(u) \in Q$, and therefore $owner(u) \notin Act(N)$.
    
\end{itemize}
	
	$W_k$ is an IN-set of $N$, thus, by the last two properties and by Lemma \ref{lem: access-visible-variable}, IN1-IN4 hold for $W_k$ in $N e = L_k$. As IN5 holds for $W_k$ in $N$, it clearly holds for any variable $v \neq u$ in $L_k$. Consider now variable $u$. Either $e$ does not commit a write to $u$, and thus $writer(u,L_k) = writer(u,N) \notin W_k$, or $e$ is a commit write to $u$, and thus $writer(u,L_k) = p_{max} \notin W_k$. In both cases, IN5 holds for $u$ in $L_k$. As a result, $W_k$ is an IN-set of $L_k$.
\end{proof}

We now prove that $L_k$ satisfies all the conditions of Lemma \ref{regularization-phase-lemma}:
\begin{enumerate} [(1)]
	\item $e$ is not a transition event, thus $Act(L_k) = Act(N) = W_k \cup \{p_{max}\}$ (where $p_{max} \notin W_k$);
	\item By claim \ref{claim: W_k-is-an-IN-set} $W_k$ is an IN-set of $L_k$;
	\item $p_{max}$ eamxecutes $\ell_{i+1}+k-1$ critical events in $N$, and $e$ is a critical event in $N e$. Therefore $p_{max}$ executes $\ell_{i+1}+k$ critical events in $L_k$;
	\item Each $p \in W_k$ executes $\ell_{i+1}$ critical events in $L_k$;
	\item Each $p \in W_k$ executes the same events in $L_k$ and in $N$, thus $p$ completed $i+1$ fences in $L_k$, and $mode(p,L_k) = read$;
	\item $Fin(L_k) = Fin(N) = Fin(H_i)$;
	\item $|Act(L_k)| = |Act(N)| \geq |Act(L)|-1$.
\end{enumerate}

\begin{claim-section} \label{claim: regularization-upper-bound}
	The number of steps in the regularization phase is bounded by $f(i+1)$. \\ (In other words, $m \leq f(i+1)$.)
\end{claim-section}
\begin{proof}
	Assume towards a contradiction that during the regularization phase we build an execution $L_k$ such that $k > f(i+1)$. Then $L_k$ satisfies:
	\begin{itemize}
		\item $Act(L_k)$ can be written as $W_k \cup \{p_{max}\}$ (where $p_{max} \notin W_k$);
		\item $W_k$ is an IN-set of $L_k$;
		\item $Fin(L_k) = Fin(H_i)$, thus $|Fin(L_k)| = i$.
		\item $p_{max}$ executes $\ell_{i+1}+k$ critical events in $L_k$.
	\end{itemize}
	Using Lemma \ref{lem: remove-invisibale-processes} with $'E' \leftarrow L_k$ and $'INV','Y' \leftarrow W_k$, we have an execution $L'_k = L_k^{-W_k}$ such that: $Act(L'_k) = Act(L_k) \setminus W_k = \{p_{max}\}$ and $Fin(L'_k) = Fin(L_k) = Fin(H_i)$; $p_{max}$ executes the same critical events in $L'_k$ and in $L_k$, thus $p_{max}$ executes $\ell_{i+1}+k$ critical events in $L'_k$.
	\\ Hence, at most $i+1$ processes issue events in $L'_k$, i.e. the total contention of $L'_k$ is at most $i+1$. However, $p_{max}$ executed $\ell_{i+1}+k > f(i+1)$ critical events during a single passage in $L'_k$, contradicting our assumption that the algorithm is $f$-adaptive.
\end{proof}




\subsection{Construction Bounds}
We now present an analysis for the size of $Act(H_i)$ based on the upper bounds on the number of steps in for each phase. We will prove a lower bound under some restriction on the growth rate of the adaptivity function $f$.

\begin{theorem} \label{theorem: Act-lower-bound}
	Let $i \in \mathbb{N}$ be such that $f(i) \leq \dfrac{N^{2^{-f(i)}}} {f(i)! \cdot 4^{f(i)+2i}}$. Then the following lower bound holds:
	$$|Act(H_i)| \geq \frac{N^{2^{-\ell_i}}}{\ell_i! \cdot 4^{\ell_i+2i}}$$
\end{theorem}



\begin{proof}
	$ $ \newline
We assume WLOG that the adaptivity function $f$ is non-decreasing. We prove the theorem by induction on $i$. For $i=0$, we have $|Act(H_0)| \geq N$ which is trivially true.

Let $i+1$ be such that:
 $$f(i+1) \leq \dfrac{N^{2^{-f(i+1)}}} {f(i+1)! \cdot 4^{f(i+1) + 2(i+1)}}$$
 Since $f$ is non-decreasing:
\begin{align*}
	& f(i) \leq f(i+1) \leq \\
	& \qquad \dfrac{N^{2^{-f(i+1)}}} {f(i+1)! \cdot 4^{f(i+1)+2(i+1)}} \leq \dfrac{N^{2^{-f(i)}}} {f(i)! \cdot 4^{f(i)+2i}}.
\end{align*}
Hence $i$ satisfies the condition in Theorem \ref{theorem: Act-lower-bound}, and by the induction hypothesis, $|Act(H_i)| \geq \frac{N^{2^{-\ell_i}}}{\ell_i! \cdot 4^{\ell_i+2i}}$.
	
The induction step is partitioned into several sub-steps, corresponding to the phases in the construction of $H_{i+1}$ from $H_i$. In each sub-step, we establish a lower bound on the number of active processes in the intermediate executions during the respective phase, based on the lower bound established for the phases preceding it.
	
	Read phase: $|Act(G_k)| \geq \dfrac{N^{2^{-(\ell_i+k)}}}{(\ell_i+k)! \cdot 4^{\ell_i+k+2i}}$.
	\\ By induction on $k$.
	\\ Base case $k=0$: then $G_0 = H_i$ and the claim holds.
	\\ Induction step: assume we proved the claim for $k-1$. By condition (5) of Lemma \ref{read-phase-lemma}:
	\begin{align*}
	& |Act(G_k)| \geq \dfrac{|Act(G_{k-1})|-1}{10} \geq \\
	& \qquad \dfrac{\frac{N^{2^{-(\ell_i+k-1)}}}{(\ell_i+k-1)! \cdot 4^{\ell_i+k-1+2i}}-1}{10} \geq \dfrac{N^{2^{-(\ell_i+k)}}}{(\ell_i+k)! \cdot 4^{\ell_i+k+2i}}
	\end{align*}
	where the last inequality holds as long as $\ell_i+k \geq 3$, which may be assumed since $\ell_i$ increases from phase
    to phase and $k$ increases in the course of the read phase.
	
	Write phase: $|Act(J_k)| \geq \dfrac{N^{2^{-(\ell_i+s+k)}}}{(\ell_i+s+k)! \cdot 4^{\ell_i+s+k+2i} \cdot 2}$
	\\ By induction on $k$.
	\\ Base case $k=0$: 
	\\ $|Act(J_0)| \geq \dfrac{|Act(G_s)|}{2} \geq \dfrac{N^{2^{-(\ell_i+s)}}}{(\ell_i+s)! \cdot 4^{\ell_i+s+2i} \cdot 2}$.
	\\ Induction step: assume we proved the claim for $k-1$. By condition (5) of Lemma \ref{write-phase-lemma}:
	\begin{align*}
	& |Act(J_k)| \geq \dfrac {\sqrt{|Act(J_{k-1})|}} {4(\delta+k)} \geq \\
	& \quad \dfrac {\sqrt{\dfrac{N^{2^{-(\ell_i+s+k-1)}}} {(\ell_i+s+k-1)! \cdot 4^{\ell_i+s+k-1+2i} \cdot 2}}} {4(\ell_i+s+k)} \geq \\
	& \qquad \dfrac {\dfrac{\sqrt{N^{2^{-(\ell_i+s+k-1)}}}} {(\ell_i+s+k-1)! \cdot 4^{\ell_i+s+k-1+2i} \cdot 2}} {4(\ell_i+s+k)} = \\
	& \qquad \quad \dfrac{N^{2^{-(\ell_i+s+k)}}}{(\ell_i+s+k)! \cdot 4^{\ell_i+s+k+2i} \cdot 2}
	\end{align*}
	
	Regularization phase:	
	 $$|Act(L_k)| \geq \dfrac{N^{2^{-\ell_{i+1}}}}{\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}} - k$$
	\\ By induction on $k$.
	\\ Base case $k=0$:
	\begin{align*}
	& |Act(L_0)| \geq \dfrac{|Act(J_t)|}{2} \geq \\
	& \quad \dfrac{\dfrac{N^{2^{-(\ell_i+s+t)}}}{(\ell_i+s+t)! \cdot 4^{\ell_i+s+t+2i} \cdot 2}}{2} = \dfrac{N^{2^{-\ell_{i+1}}}}{\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}}
	\end{align*}
	\\ Induction step: assume we proved the claim for $k-1$. By condition (7) of Lemma \ref{regularization-phase-lemma}:
	$$|Act(L_k)| \geq |Act(L_{k-1})|-1 \geq \dfrac{N^{2^{-\ell_{i+1}}}}{\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}} - k$$.
	
	Therefore we have:
	\begin{equation} \label{eq: Act(H_i)-bound}
		\begin{aligned}
			& |Act(H_{i+1})| = |Act(L_m)| - 1 \geq \\
			& \qquad \dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}}-(m+1)
		\end{aligned}
	\end{equation}
	
	From claim \ref{claim: regularization-upper-bound} and our assumption,
	$$m \leq f(i+1) \leq \dfrac{N^{2^{-f(i+1)}}} {f(i+1)! \cdot 4^{f(i+1) + 2(i+1)}}$$
	\\ By Claim \ref{claim: write-upper-bound}, $\ell_{i+1} \leq f(i+1)$. Therefore, we can replace $f(i+1)$ with $\ell_{i+1}$ to get:
	\begin{equation} \label{eq: m-bound}
		\begin{aligned}
			& m \leq \dfrac{N^{2^{-f(i+1)}}} {f(i+1)! \cdot 4^{f(i+1) + 2(i+1)}} \leq \\
			& \qquad \dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1} + 2(i+1)}} = \qquad \dfrac{1}{4} \cdot \dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}}
		\end{aligned}
	\end{equation}
	
	
	Plugging Inequality \ref{eq: m-bound} into Inequality \ref{eq: Act(H_i)-bound} yields the required lower bound:
	\begin{align*}
		& |Act(H_{i+1})| \geq
		\dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}}-(m+1) \geq \\
		& \quad \dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}}-\dfrac{1}{2} \cdot \dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}} = \\
		& \qquad \dfrac{1}{2} \cdot \dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2i+1}} \geq
		\dfrac{N^{2^{-\ell_{i+1}}}} {\ell_{i+1}! \cdot 4^{\ell_{i+1}+2(i+1)}}
	\end{align*}
\end{proof}

We can now prove our main result.

\begin{theorem-repeat} {main-theorem}
	Let $\mathcal{A}$ be an $N$-process weak obstruction-free $f$-adaptive implementation of a mutual-exclusion lock and let $i \in \mathbb{N}$ be such that $f(i) \leq \dfrac{N^{2^{-f(i)}}} {f(i)! \cdot 4^{f(i)+2i}}$.
	Then there exists an execution $H$ whose total contention is $i+1$ and a process $p$ such that $p$ executes $i$ fences in $H$ during a single passage of its CS.\end{theorem-repeat}

\begin{proof}
Since $l_i < f(i)$, it follows from Theorem \ref{theorem: Act-lower-bound} that $|Act(H_i)| \geq f(i) \geq 1$. This implies that our construction results in an execution $H_i$, in which there is a process $p \in Act(H_i)$ and, from the properties of $H_i$, $p$ is in a middle of a passage in which it executed (and completed) $i$ fences.
Moreover, from Lemma \ref{lem: remove-invisibale-processes}, we are able to erase all active processes but $p$ from $H_i$ and obtain an execution $H$, in which $p$ executes $i$ fences in the course of a single passage, and the total contention of $H$ is $i+1$, that is, the number of fences $p$ executes is linear in the total contention of the execution.
\end{proof}


